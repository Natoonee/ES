# 高级数据库技术聚合操作练习

学院：省级示范性软件学院
题目：《 实验三：聚合操作练习》
姓名：杨尧炜
学号：2200770008
班级：软工2201
日期：2024-10-12
实验环境： Elasticsearch8.12.2 apifox

## 一.实验目的 
Elasticsearch 聚合操作练习
完成题目中的任意15道题。
Elasticsearch聚合操作练习的实验目的是掌握数据分组、统计和计算的方法，提升数据分析与决策支持能力。
## 二.实验内容 
电商数据分析：
索引表述信息：
1. order_id: 订单ID
2. order_date: 订单日期
3. customer_id: 客户ID
4. customer_name: 客户姓名
5. customer_gender: 客户性别
6. customer_age: 客户年龄
7. customer_city: 客户所在城市
8. product_id: 产品ID
9. product_name: 产品名称
10. product_category: 产品类别
11. quantity: 购买数量
12. price: 单价
13. total_amount: 总金额
14. payment_method: 支付方式
15. is_returned: 是否退货
```
PUT /ecommerce
{
  "mappings": {
    "properties": {
      "order_id": { "type": "keyword" },
      "order_date": { "type": "date" },
      "customer_id": { "type": "keyword" },
      "customer_name": { "type": "keyword" },
      "customer_gender": { "type": "keyword" },
      "customer_age": { "type": "integer" },
      "customer_city": { "type": "keyword" },
      "product_id": { "type": "keyword" },
      "product_name": { "type": "keyword" },
      "product_category": { "type": "keyword" },
      "quantity": { "type": "integer" },
      "price": { "type": "float" },
      "total_amount": { "type": "float" },
      "payment_method": { "type": "keyword" },
      "is_returned": { "type": "boolean" }
    }
  }
}

```
-![QQ20241012-170723](pot\QQ20241012-170723.png)

```
POST /ecommerce/_bulk
```
-![QQ20241012-171017](pot\QQ20241012-171017.png)

### 1. 统计每个产品类别的总销售额。

```
{
  "aggs": {
    "total_sales_by_category": {
      "terms": {
        "field": "product_category"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-172037](pot\QQ20241012-172037.png)

```
结果部分代码
    "aggregations": {
        "total_sales_by_category": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": "Jewelry",
                    "doc_count": 14,
                    "total_sales": {
                        "value": 17477.37028503418
                    }
                },
                {
                    "key": "Electronics",
                    "doc_count": 13,
                    "total_sales": {
                        "value": 18941.559997558594
                    }
                },
                {
                    "key": "Home Appliances",
                    "doc_count": 13,
                    "total_sales": {
                        "value": 25865.190231323242
                    }
                },
                {
                    "key": "Beauty",
                    "doc_count": 11,
                    "total_sales": {
                        "value": 22708.94012451172
                    }
                },
                {
                    "key": "Furniture",
                    "doc_count": 10,
                    "total_sales": {
                        "value": 17228.31996154785
                    }
                },
                {
                    "key": "Books",
                    "doc_count": 9,
                    "total_sales": {
                        "value": 11878.820098876953
                    }
                },
                {
                    "key": "Groceries",
                    "doc_count": 9,
                    "total_sales": {
                        "value": 16172.980072021484
                    }
                },
                {
                    "key": "Fashion",
                    "doc_count": 8,
                    "total_sales": {
                        "value": 7073.110048294067
                    }
                },
                {
                    "key": "Toys",
                    "doc_count": 7,
                    "total_sales": {
                        "value": 10528.830047607422
                    }
                },
                {
                    "key": "Sports",
                    "doc_count": 6,
                    "total_sales": {
                        "value": 13250.500122070312
                    }
```

### 2. 计算每个城市的平均订单金额。

```
{
  "aggs": {
    "avg_order_by_city": {
      "terms": {
        "field": "customer_city"
      },
      "aggs": {
        "avg_order_amount": {
          "avg": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-172127](pot\QQ20241012-172127.png)
```
结果部分代码
    "aggregations": {
        "avg_order_by_city": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": "Los Angeles",
                    "doc_count": 13,
                    "avg_order_amount": {
                        "value": 1482.7977142333984
                    }
                },
                {
                    "key": "San Diego",
                    "doc_count": 13,
                    "avg_order_amount": {
                        "value": 1878.4761915940505
                    }
                },
                {
                    "key": "San Jose",
                    "doc_count": 12,
                    "avg_order_amount": {
                        "value": 1587.2216771443684
                    }
                },
                {
                    "key": "Philadelphia",
                    "doc_count": 11,
                    "avg_order_amount": {
                        "value": 1370.19365345348
                    }
                },
                {
                    "key": "New York",
                    "doc_count": 10,
                    "avg_order_amount": {
                        "value": 1801.9510040283203
                    }
                },
                {
                    "key": "Chicago",
                    "doc_count": 9,
                    "avg_order_amount": {
                        "value": 1062.1610989040798
                    }
                },
                {
                    "key": "Houston",
                    "doc_count": 9,
                    "avg_order_amount": {
                        "value": 1735.199978298611
                    }
                },
                {
                    "key": "Dallas",
                    "doc_count": 8,
                    "avg_order_amount": {
                        "value": 1291.8024978637695
                    }
                },
                {
                    "key": "Phoenix",
                    "doc_count": 8,
                    "avg_order_amount": {
                        "value": 2315.7625274658203
                    }
                },
                {
                    "key": "San Antonio",
                    "doc_count": 7,
                    "avg_order_amount": {
                        "value": 1607.7128516605922
                    }
                }
```

### 3. 找出销量最高的前5个产品。

```
{
  "aggs": {
    "top_5_products": {
      "terms": {
        "field": "product_name",
        "size": 5
      },
      "aggs": {
        "total_quantity": {
          "sum": {
            "field": "quantity"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-172210](pot\QQ20241012-172210.png)
```
结果部分代码
    "aggregations": {
        "top_5_products": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 67,
            "buckets": [
                {
                    "key": "Ultra Accessory",
                    "doc_count": 8,
                    "total_quantity": {
                        "value": 22.0
                    }
                },
                {
                    "key": "Ultra Device",
                    "doc_count": 7,
                    "total_quantity": {
                        "value": 24.0
                    }
                },
                {
                    "key": "Elite Accessory",
                    "doc_count": 6,
                    "total_quantity": {
                        "value": 25.0
                    }
                },
                {
                    "key": "Ultra Gadget",
                    "doc_count": 6,
                    "total_quantity": {
                        "value": 21.0
                    }
                },
                {
                    "key": "Ultra Tool",
                    "doc_count": 6,
                    "total_quantity": {
                        "value": 21.0
                    }
                }

```

### 4. 计算男性和女性客户的平均年龄。

```
{
  "aggs": {
    "avg_age_by_gender": {
      "terms": {
        "field": "customer_gender"
      },
      "aggs": {
        "avg_age": {
          "avg": {
            "field": "customer_age"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-172238](pot\QQ20241012-172238.png)
```
结果部分代码
    "aggregations": {
        "avg_age_by_gender": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": "male",
                    "doc_count": 55,
                    "avg_age": {
                        "value": 45.61818181818182
                    }
                },
                {
                    "key": "female",
                    "doc_count": 45,
                    "avg_age": {
                        "value": 43.888888888888886
                    }
                }
            ]
        }
    }
}
```

### 5. 统计每种支付方式的使用次数和总金额。

```
{
  "aggs": {
    "payment_method_stats": {
      "terms": {
        "field": "payment_method"
      },
      "aggs": {
        "usage_count": {
          "value_count": {
            "field": "order_id"
          }
        },
        "total_amount": {
          "sum": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-172334](pot\QQ20241012-172334.png)
```
{
    "took": 3,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 100,
            "relation": "eq"
        },
        "max_score": 1.0,
        "hits": [
            {
                "_index": "ecommerce",
                "_id": "1",
                "_score": 1.0,
                "_source": {
                    "order_id": "6945",
                    "order_date": "2023-03-06",
                    "customer_id": "C242",
                    "customer_name": "Bob Smith",
                    "customer_gender": "female",
                    "customer_age": 60,
                    "customer_city": "Philadelphia",
                    "product_id": "P041",
                    "product_name": "Pro Accessory",
                    "product_category": "Sports",
                    "quantity": 4,
                    "price": 205.89,
                    "total_amount": 823.56,
                    "payment_method": "Credit Card",
                    "is_returned": false
                }
            },
            {
                "_index": "ecommerce",
                "_id": "2",
                "_score": 1.0,
                "_source": {
                    "order_id": "5629",
                    "order_date": "2023-11-14",
                    "customer_id": "C262",
                    "customer_name": "Frank Garcia",
                    "customer_gender": "female",
                    "customer_age": 52,
                    "customer_city": "Dallas",
                    "product_id": "P097",
                    "product_name": "Ultra Accessory",
                    "product_category": "Sports",
                    "quantity": 3,
                    "price": 475.18,
                    "total_amount": 1425.54,
                    "payment_method": "Debit Card",
                    "is_returned": true
                }
            },
            {
                "_index": "ecommerce",
                "_id": "3",
                "_score": 1.0,
                "_source": {
                    "order_id": "4488",
                    "order_date": "2023-03-28",
                    "customer_id": "C342",
                    "customer_name": "Frank Garcia",
                    "customer_gender": "female",
                    "customer_age": 62,
                    "customer_city": "New York",
                    "product_id": "P001",
                    "product_name": "Ultra Device",
                    "product_category": "Books",
                    "quantity": 5,
                    "price": 722.89,
                    "total_amount": 3614.45,
                    "payment_method": "Credit Card",
                    "is_returned": false
                }
            },
            {
                "_index": "ecommerce",
                "_id": "4",
                "_score": 1.0,
                "_source": {
                    "order_id": "7960",
                    "order_date": "2023-09-23",
                    "customer_id": "C408",
                    "customer_name": "Eva Johnson",
                    "customer_gender": "male",
                    "customer_age": 37,
                    "customer_city": "San Antonio",
                    "product_id": "P079",
                    "product_name": "Ultra Accessory",
                    "product_category": "Home Appliances",
                    "quantity": 2,
                    "price": 485.3,
                    "total_amount": 970.6,
                    "payment_method": "Cash on Delivery",
                    "is_returned": false
                }
            },
            {
                "_index": "ecommerce",
                "_id": "5",
                "_score": 1.0,
                "_source": {
                    "order_id": "2111",
                    "order_date": "2023-02-18",
                    "customer_id": "C981",
                    "customer_name": "Eva Garcia",
                    "customer_gender": "female",
                    "customer_age": 19,
                    "customer_city": "Los Angeles",
                    "product_id": "P091",
                    "product_name": "Mega Widget",
                    "product_category": "Books",
                    "quantity": 5,
                    "price": 61.52,
                    "total_amount": 307.6,
                    "payment_method": "Debit Card",
                    "is_returned": false
                }
            },
            {
                "_index": "ecommerce",
                "_id": "6",
                "_score": 1.0,
                "_source": {
                    "order_id": "2121",
                    "order_date": "2023-01-10",
                    "customer_id": "C030",
                    "customer_name": "Jack Davis",
                    "customer_gender": "male",
                    "customer_age": 18,
                    "customer_city": "Chicago",
                    "product_id": "P070",
                    "product_name": "Ultra Tool",
                    "product_category": "Home Appliances",
                    "quantity": 3,
                    "price": 860.58,
                    "total_amount": 2581.74,
                    "payment_method": "Debit Card",
                    "is_returned": true
                }
            },
            {
                "_index": "ecommerce",
                "_id": "7",
                "_score": 1.0,
                "_source": {
                    "order_id": "1211",
                    "order_date": "2023-07-06",
                    "customer_id": "C672",
                    "customer_name": "Jack Williams",
                    "customer_gender": "female",
                    "customer_age": 64,
                    "customer_city": "San Diego",
                    "product_id": "P092",
                    "product_name": "Mega Device",
                    "product_category": "Electronics",
                    "quantity": 4,
                    "price": 389.1,
                    "total_amount": 1556.4,
                    "payment_method": "Cash on Delivery",
                    "is_returned": true
                }
            },
            {
                "_index": "ecommerce",
                "_id": "8",
                "_score": 1.0,
                "_source": {
                    "order_id": "7394",
                    "order_date": "2023-08-15",
                    "customer_id": "C719",
                    "customer_name": "Frank Rodriguez",
                    "customer_gender": "female",
                    "customer_age": 59,
                    "customer_city": "San Diego",
                    "product_id": "P083",
                    "product_name": "Super Device",
                    "product_category": "Beauty",
                    "quantity": 2,
                    "price": 593.15,
                    "total_amount": 1186.3,
                    "payment_method": "Credit Card",
                    "is_returned": true
                }
            },
            {
                "_index": "ecommerce",
                "_id": "9",
                "_score": 1.0,
                "_source": {
                    "order_id": "7593",
                    "order_date": "2023-07-22",
                    "customer_id": "C145",
                    "customer_name": "Bob Johnson",
                    "customer_gender": "female",
                    "customer_age": 33,
                    "customer_city": "Dallas",
                    "product_id": "P031",
                    "product_name": "Pro Tool",
                    "product_category": "Furniture",
                    "quantity": 3,
                    "price": 740.32,
                    "total_amount": 2220.96,
                    "payment_method": "PayPal",
                    "is_returned": false
                }
            },
            {
                "_index": "ecommerce",
                "_id": "10",
                "_score": 1.0,
                "_source": {
                    "order_id": "3304",
                    "order_date": "2023-03-03",
                    "customer_id": "C111",
                    "customer_name": "Jack Jones",
                    "customer_gender": "female",
                    "customer_age": 53,
                    "customer_city": "Chicago",
                    "product_id": "P027",
                    "product_name": "Elite Device",
                    "product_category": "Jewelry",
                    "quantity": 1,
                    "price": 489.24,
                    "total_amount": 489.24,
                    "payment_method": "Credit Card",
                    "is_returned": true
                }
            }
        ]
    },
    "aggregations": {
        "payment_method_stats": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": "Cash on Delivery",
                    "doc_count": 29,
                    "usage_count": {
                        "value": 29
                    },
                    "total_amount": {
                        "value": 38746.55044555664
                    }
                },
                {
                    "key": "Debit Card",
                    "doc_count": 29,
                    "usage_count": {
                        "value": 29
                    },
                    "total_amount": {
                        "value": 48975.19040107727
                    }
                },
                {
                    "key": "Credit Card",
                    "doc_count": 22,
                    "usage_count": {
                        "value": 22
                    },
                    "total_amount": {
                        "value": 36358.470153808594
                    }
                },
                {
                    "key": "PayPal",
                    "doc_count": 20,
                    "usage_count": {
                        "value": 20
                    },
                    "total_amount": {
                        "value": 37045.40998840332
                    }
                }
            ]
        }
    }
}
```

### 6. 计算每月的总销售额。

```
{
  "size": 0,
  "aggs": {
    "monthly_sales": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "month"  
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-172900](pot\QQ20241012-172900.png)
```
结果部分代码
    "aggregations": {
        "monthly_sales": {
            "buckets": [
                {
                    "key_as_string": "2023-01-01T00:00:00.000Z",
                    "key": 1672531200000,
                    "doc_count": 12,
                    "total_sales": {
                        "value": 24381.61993408203
                    }
                },
                {
                    "key_as_string": "2023-02-01T00:00:00.000Z",
                    "key": 1675209600000,
                    "doc_count": 11,
                    "total_sales": {
                        "value": 18870.850006103516
                    }
                },
                {
                    "key_as_string": "2023-03-01T00:00:00.000Z",
                    "key": 1677628800000,
                    "doc_count": 10,
                    "total_sales": {
                        "value": 17959.33026123047
                    }
                },
                {
                    "key_as_string": "2023-04-01T00:00:00.000Z",
                    "key": 1680307200000,
                    "doc_count": 9,
                    "total_sales": {
                        "value": 18775.959869384766
                    }
                },
                {
                    "key_as_string": "2023-05-01T00:00:00.000Z",
                    "key": 1682899200000,
                    "doc_count": 10,
                    "total_sales": {
                        "value": 11713.169967651367
                    }
                },
                {
                    "key_as_string": "2023-06-01T00:00:00.000Z",
                    "key": 1685577600000,
                    "doc_count": 9,
                    "total_sales": {
                        "value": 6771.1600341796875
                    }
                },
                {
                    "key_as_string": "2023-07-01T00:00:00.000Z",
                    "key": 1688169600000,
                    "doc_count": 7,
                    "total_sales": {
                        "value": 9110.010131835938
                    }
                },
                {
                    "key_as_string": "2023-08-01T00:00:00.000Z",
                    "key": 1690848000000,
                    "doc_count": 8,
                    "total_sales": {
                        "value": 12135.870210647583
                    }
                },
                {
                    "key_as_string": "2023-09-01T00:00:00.000Z",
                    "key": 1693526400000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 8615.500122070312
                    }
                },
                {
                    "key_as_string": "2023-10-01T00:00:00.000Z",
                    "key": 1696118400000,
                    "doc_count": 6,
                    "total_sales": {
                        "value": 12106.000183105469
                    }
                },
                {
                    "key_as_string": "2023-11-01T00:00:00.000Z",
                    "key": 1698796800000,
                    "doc_count": 6,
                    "total_sales": {
                        "value": 8176.529968261719
                    }
                },
                {
                    "key_as_string": "2023-12-01T00:00:00.000Z",
                    "key": 1701388800000,
                    "doc_count": 9,
                    "total_sales": {
                        "value": 12509.620300292969
                    }
                }
            ]
        }
    }
}
```

### 7. 找出平均订单金额最高的前3个客户。

```
{
  "aggs": {
    "top_3_customers": {
      "terms": {
        "field": "customer_id",
        "size": 3
      },
      "aggs": {
        "avg_order_amount": {
          "avg": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-172933](pot\QQ20241012-172933.png)
```
结果部分代码
    "aggregations": {
        "top_3_customers": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 94,
            "buckets": [
                {
                    "key": "C003",
                    "doc_count": 2,
                    "avg_order_amount": {
                        "value": 1896.160026550293
                    }
                },
                {
                    "key": "C336",
                    "doc_count": 2,
                    "avg_order_amount": {
                        "value": 896.1250152587891
                    }
                },
                {
                    "key": "C365",
                    "doc_count": 2,
                    "avg_order_amount": {
                        "value": 428.7350082397461
                    }
                }
            ]
        }
    }
}
```

### 8. 计算每个年龄段（18-30，31-50，51+）的客户数量。

```
{
  "aggs": {
    "age_groups": {
      "range": {
        "field": "customer_age",
        "ranges": [
          { "key": "18-30", "from": 18, "to": 31 },
          { "key": "31-50", "from": 31, "to": 51 },
          { "key": "51+", "from": 51 }
        ]
      }
    }
  }
}

```
-![QQ20241012-172959](pot\QQ20241012-172959.png)
```
结果部分代码
    "aggregations": {
        "age_groups": {
            "buckets": [
                {
                    "key": "18-30",
                    "from": 18.0,
                    "to": 31.0,
                    "doc_count": 25
                },
                {
                    "key": "31-50",
                    "from": 31.0,
                    "to": 51.0,
                    "doc_count": 33
                },
                {
                    "key": "51+",
                    "from": 51.0,
                    "doc_count": 42
                }
            ]
        }
    }
}
```

### 9. 计算每个产品类别的平均单价。

```
{
  "aggs": {
    "avg_price_by_category": {
      "terms": {
        "field": "product_category"
      },
      "aggs": {
        "avg_price": {
          "avg": {
            "field": "price"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-173026](pot\QQ20241012-173026.png)
```
结果部分代码

    "aggregations": {
        "avg_price_by_category": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": "Jewelry",
                    "doc_count": 14,
                    "avg_price": {
                        "value": 537.6807218279157
                    }
                },
                {
                    "key": "Electronics",
                    "doc_count": 13,
                    "avg_price": {
                        "value": 484.44461763822113
                    }
                },
                {
                    "key": "Home Appliances",
                    "doc_count": 13,
                    "avg_price": {
                        "value": 645.6961549612192
                    }
                },
                {
                    "key": "Beauty",
                    "doc_count": 11,
                    "avg_price": {
                        "value": 701.0781749378551
                    }
                },
                {
                    "key": "Furniture",
                    "doc_count": 10,
                    "avg_price": {
                        "value": 518.5519981384277
                    }
                },
                {
                    "key": "Books",
                    "doc_count": 9,
                    "avg_price": {
                        "value": 524.0977762010363
                    }
                },
                {
                    "key": "Groceries",
                    "doc_count": 9,
                    "avg_price": {
                        "value": 566.4644444783529
                    }
                },
                {
                    "key": "Fashion",
                    "doc_count": 8,
                    "avg_price": {
                        "value": 369.4774992465973
                    }
                },
                {
                    "key": "Toys",
                    "doc_count": 7,
                    "avg_price": {
                        "value": 485.97999899727955
                    }
                },
                {
                    "key": "Sports",
                    "doc_count": 6,
                    "avg_price": {
                        "value": 483.9566599527995
                    }
                }
            ]
        }
    }
}
```
### 10. 找出订单数量最多的前5个城市。

```
{
  "aggs": {
    "top_5_cities_by_orders": {
      "terms": {
        "field": "customer_city",
        "size": 5
      },
      "aggs": {
        "order_count": {
          "value_count": {
            "field": "order_id"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-173119](pot\QQ20241012-173119.png)

```
结果部分代码
    "aggregations": {
        "top_5_cities_by_orders": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 41,
            "buckets": [
                {
                    "key": "Los Angeles",
                    "doc_count": 13,
                    "order_count": {
                        "value": 13
                    }
                },
                {
                    "key": "San Diego",
                    "doc_count": 13,
                    "order_count": {
                        "value": 13
                    }
                },
                {
                    "key": "San Jose",
                    "doc_count": 12,
                    "order_count": {
                        "value": 12
                    }
                },
                {
                    "key": "Philadelphia",
                    "doc_count": 11,
                    "order_count": {
                        "value": 11
                    }
                },
                {
                    "key": "New York",
                    "doc_count": 10,
                    "order_count": {
                        "value": 10
                    }
                }
            ]
        }
    }
}
```

### 11. 计算每个季度的平均订单金额。

```
{
  "aggs": {
    "quarterly_avg_order": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "quarter"  
      },
      "aggs": {
        "avg_order_amount": {
          "avg": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-173321](pot\QQ20241012-173321.png)

```
结果部分代码
    "aggregations": {
        "quarterly_avg_order": {
            "buckets": [
                {
                    "key_as_string": "2023-01-01T00:00:00.000Z",
                    "key": 1672531200000,
                    "doc_count": 33,
                    "avg_order_amount": {
                        "value": 1854.9030364065459
                    }
                },
                {
                    "key_as_string": "2023-04-01T00:00:00.000Z",
                    "key": 1680307200000,
                    "doc_count": 28,
                    "avg_order_amount": {
                        "value": 1330.724638257708
                    }
                },
                {
                    "key_as_string": "2023-07-01T00:00:00.000Z",
                    "key": 1688169600000,
                    "doc_count": 18,
                    "avg_order_amount": {
                        "value": 1658.9655813641018
                    }
                },
                {
                    "key_as_string": "2023-10-01T00:00:00.000Z",
                    "key": 1696118400000,
                    "doc_count": 21,
                    "avg_order_amount": {
                        "value": 1561.530973888579
                    }
                }
            ]
```

### 12. 统计每个产品类别中的商品数量。

```
{
  "aggs": {
    "product_count_by_category": {
      "terms": {
        "field": "product_category"
      },
      "aggs": {
        "product_count": {
          "value_count": {
            "field": "product_id"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-173357](pot\QQ20241012-173357.png)

```
结果部分代码
    "aggregations": {
        "product_count_by_category": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": "Jewelry",
                    "doc_count": 14,
                    "product_count": {
                        "value": 14
                    }
                },
                {
                    "key": "Electronics",
                    "doc_count": 13,
                    "product_count": {
                        "value": 13
                    }
                },
                {
                    "key": "Home Appliances",
                    "doc_count": 13,
                    "product_count": {
                        "value": 13
                    }
                },
                {
                    "key": "Beauty",
                    "doc_count": 11,
                    "product_count": {
                        "value": 11
                    }
                },
                {
                    "key": "Furniture",
                    "doc_count": 10,
                    "product_count": {
                        "value": 10
                    }
                },
                {
                    "key": "Books",
                    "doc_count": 9,
                    "product_count": {
                        "value": 9
                    }
                },
                {
                    "key": "Groceries",
                    "doc_count": 9,
                    "product_count": {
                        "value": 9
                    }
                },
                {
                    "key": "Fashion",
                    "doc_count": 8,
                    "product_count": {
                        "value": 8
                    }
                },
                {
                    "key": "Toys",
                    "doc_count": 7,
                    "product_count": {
                        "value": 7
                    }
                },
                {
                    "key": "Sports",
                    "doc_count": 6,
                    "product_count": {
                        "value": 6
                    }
                }
            ]
        }
    }
}
```

### 13. 计算男性和女性客户的平均订单金额。

```
{
  "aggs": {
    "avg_order_by_gender": {
      "terms": {
        "field": "customer_gender"
      },
      "aggs": {
        "avg_order_amount": {
          "avg": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-173425](pot\QQ20241012-173425.png)
```
结果部分代码
    "aggregations": {
        "avg_order_by_gender": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": "male",
                    "doc_count": 55,
                    "avg_order_amount": {
                        "value": 1798.5043728915127
                    }
                },
                {
                    "key": "female",
                    "doc_count": 45,
                    "avg_order_amount": {
                        "value": 1382.397343995836
                    }
                }
            ]
        }
    }
}
```

### 14. 找出总销售额最高的前10个日期。

```
{
  "size": 0,
  "aggs": {
    "top_10_dates_by_sales": {
      "terms": {
        "script": {
          "source": "doc['order_date'].value.toInstant().toEpochMilli()",
          "lang": "painless"
        },
        "size": 10,
        "order": {
          "total_sales": "desc"
        }
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}


```
-![QQ20241012-173606](pot\QQ20241012-173606.png)
```
结果部分代码
    "aggregations": {
        "top_10_dates_by_sales": {
            "doc_count_error_upper_bound": -1,
            "sum_other_doc_count": 86,
            "buckets": [
                {
                    "key": "1682726400000",
                    "doc_count": 2,
                    "total_sales": {
                        "value": 5951.77001953125
                    }
                },
                {
                    "key": "1677628800000",
                    "doc_count": 2,
                    "total_sales": {
                        "value": 5457.640075683594
                    }
                },
                {
                    "key": "1703980800000",
                    "doc_count": 2,
                    "total_sales": {
                        "value": 5177.3402099609375
                    }
                },
                {
                    "key": "1694736000000",
                    "doc_count": 1,
                    "total_sales": {
                        "value": 4886.10009765625
                    }
                },
                {
                    "key": "1696291200000",
                    "doc_count": 1,
                    "total_sales": {
                        "value": 4858.9501953125
                    }
                },
                {
                    "key": "1678665600000",
                    "doc_count": 1,
                    "total_sales": {
                        "value": 4592.9501953125
                    }
                },
                {
                    "key": "1691107200000",
                    "doc_count": 1,
                    "total_sales": {
                        "value": 4131.9501953125
                    }
                },
                {
                    "key": "1677283200000",
                    "doc_count": 2,
                    "total_sales": {
                        "value": 3872.6699829101562
                    }
                },
                {
                    "key": "1681171200000",
                    "doc_count": 1,
                    "total_sales": {
                        "value": 3790.89990234375
                    }
                },
                {
                    "key": "1674777600000",
                    "doc_count": 1,
                    "total_sales": {
                        "value": 3714.25
                    }
                }
            ]
        }
    }
}
```

### 15. 计算每个季度销售额最高的产品类别。

```
{
  "aggs": {
    "quarterly_sales_by_category": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "quarter"
      },
      "aggs": {
        "sales_by_category": {
          "terms": {
            "field": "product_category"
          },
          "aggs": {
            "total_sales": {
              "sum": {
                "field": "total_amount"
              }
            }
          }
        }
      }
    }
  }
}

```
-![QQ20241012-173606](pot\QQ20241012-173606.png)
```
结果部分代码
    "aggregations": {
        "quarterly_sales_by_category": {
            "buckets": [
                {
                    "key_as_string": "2023-01-01T00:00:00.000Z",
                    "key": 1672531200000,
                    "doc_count": 33,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Jewelry",
                                "doc_count": 8,
                                "total_sales": {
                                    "value": 11757.280212402344
                                }
                            },
                            {
                                "key": "Electronics",
                                "doc_count": 5,
                                "total_sales": {
                                    "value": 8073.159973144531
                                }
                            },
                            {
                                "key": "Furniture",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 8743.890014648438
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 4522.739959716797
                                }
                            },
                            {
                                "key": "Toys",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 7987.280029296875
                                }
                            },
                            {
                                "key": "Beauty",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 4612.440002441406
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1948.3999633789062
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 4123.97998046875
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 5443.77001953125
                                }
                            },
                            {
                                "key": "Sports",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 3998.8600463867188
                                }
                            }
                        ]
                    }
                },
                {
                    "key_as_string": "2023-04-01T00:00:00.000Z",
                    "key": 1680307200000,
                    "doc_count": 28,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Furniture",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 5408.469985961914
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 6474.219955444336
                                }
                            },
                            {
                                "key": "Beauty",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 5781.5098876953125
                                }
                            },
                            {
                                "key": "Electronics",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 6231.419921875
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 2786.490020751953
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 5680.110076904297
                                }
                            },
                            {
                                "key": "Jewelry",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 1856.9000091552734
                                }
                            },
                            {
                                "key": "Toys",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 1850.3700256347656
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1190.7999877929688
                                }
                            }
                        ]
                    }
                },
                {
                    "key_as_string": "2023-07-01T00:00:00.000Z",
                    "key": 1688169600000,
                    "doc_count": 18,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Electronics",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 3483.2700805664062
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 6066.1199951171875
                                }
                            },
                            {
                                "key": "Beauty",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 2898.10009765625
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 4864.370178222656
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1360.0800495147705
                                }
                            },
                            {
                                "key": "Furniture",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 3075.9599609375
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 2173.02001953125
                                }
                            },
                            {
                                "key": "Jewelry",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 363.17999267578125
                                }
                            },
                            {
                                "key": "Sports",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 4886.10009765625
                                }
                            },
                            {
                                "key": "Toys",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 691.1799926757812
                                }
                            }
                        ]
                    }
                },
                {
                    "key_as_string": "2023-10-01T00:00:00.000Z",
                    "key": 1696118400000,
                    "doc_count": 21,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Beauty",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 9416.89013671875
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 7881.080261230469
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 4195.8699951171875
                                }
                            },
                            {
                                "key": "Sports",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 4365.539978027344
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1300.9099731445312
                                }
                            },
                            {
                                "key": "Electronics",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1153.7100219726562
                                }
                            },
                            {
                                "key": "Jewelry",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 3500.0100708007812
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 978.1400146484375
                                }
                            }
                        ]
                    }
                }
            ]
        }
    }
}
```

### 16. 计算每天的订单数量，并显示7天移动平均值。

```
{
  "size": 0,
  "aggs": {
    "daily_order_count": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "day"
      },
      "aggs": {
        "order_count": {
          "value_count": {
            "field": "order_id"
          }
        },
        "moving_average": {
          "moving_fn": {
            "buckets_path": "order_count",  
            "window": 7,
            "script": "if (params._value != null) { return params._value; } else { return 0; }"
          }
        }
      }
    }
  }
}


```
-![QQ20241012-174259](pot\QQ20241012-174259.png)
```
结果部分代码
    "aggregations": {
        "quarterly_sales_by_category": {
            "buckets": [
                {
                    "key_as_string": "2023-01-01T00:00:00.000Z",
                    "key": 1672531200000,
                    "doc_count": 33,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Jewelry",
                                "doc_count": 8,
                                "total_sales": {
                                    "value": 11757.280212402344
                                }
                            },
                            {
                                "key": "Electronics",
                                "doc_count": 5,
                                "total_sales": {
                                    "value": 8073.159973144531
                                }
                            },
                            {
                                "key": "Furniture",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 8743.890014648438
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 4522.739959716797
                                }
                            },
                            {
                                "key": "Toys",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 7987.280029296875
                                }
                            },
                            {
                                "key": "Beauty",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 4612.440002441406
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1948.3999633789062
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 4123.97998046875
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 5443.77001953125
                                }
                            },
                            {
                                "key": "Sports",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 3998.8600463867188
                                }
                            }
                        ]
                    }
                },
                {
                    "key_as_string": "2023-04-01T00:00:00.000Z",
                    "key": 1680307200000,
                    "doc_count": 28,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Furniture",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 5408.469985961914
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 6474.219955444336
                                }
                            },
                            {
                                "key": "Beauty",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 5781.5098876953125
                                }
                            },
                            {
                                "key": "Electronics",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 6231.419921875
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 2786.490020751953
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 5680.110076904297
                                }
                            },
                            {
                                "key": "Jewelry",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 1856.9000091552734
                                }
                            },
                            {
                                "key": "Toys",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 1850.3700256347656
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1190.7999877929688
                                }
                            }
                        ]
                    }
                },
                {
                    "key_as_string": "2023-07-01T00:00:00.000Z",
                    "key": 1688169600000,
                    "doc_count": 18,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Electronics",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 3483.2700805664062
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 6066.1199951171875
                                }
                            },
                            {
                                "key": "Beauty",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 2898.10009765625
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 4864.370178222656
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1360.0800495147705
                                }
                            },
                            {
                                "key": "Furniture",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 3075.9599609375
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 2173.02001953125
                                }
                            },
                            {
                                "key": "Jewelry",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 363.17999267578125
                                }
                            },
                            {
                                "key": "Sports",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 4886.10009765625
                                }
                            },
                            {
                                "key": "Toys",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 691.1799926757812
                                }
                            }
                        ]
                    }
                },
                {
                    "key_as_string": "2023-10-01T00:00:00.000Z",
                    "key": 1696118400000,
                    "doc_count": 21,
                    "sales_by_category": {
                        "doc_count_error_upper_bound": 0,
                        "sum_other_doc_count": 0,
                        "buckets": [
                            {
                                "key": "Beauty",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 9416.89013671875
                                }
                            },
                            {
                                "key": "Home Appliances",
                                "doc_count": 4,
                                "total_sales": {
                                    "value": 7881.080261230469
                                }
                            },
                            {
                                "key": "Groceries",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 4195.8699951171875
                                }
                            },
                            {
                                "key": "Sports",
                                "doc_count": 3,
                                "total_sales": {
                                    "value": 4365.539978027344
                                }
                            },
                            {
                                "key": "Books",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1300.9099731445312
                                }
                            },
                            {
                                "key": "Electronics",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 1153.7100219726562
                                }
                            },
                            {
                                "key": "Jewelry",
                                "doc_count": 2,
                                "total_sales": {
                                    "value": 3500.0100708007812
                                }
                            },
                            {
                                "key": "Fashion",
                                "doc_count": 1,
                                "total_sales": {
                                    "value": 978.1400146484375
                                }
                            }
                        ]
                    }
                }
            ]
        }
    }
}
```

### 17. 比较本月销售额与上月销售额的差异。

```
{
  "aggs": {
    "sales_comparison": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-174331](pot\QQ20241012-174331.png)
```
结果部分代码
    "aggregations": {
        "sales_comparison": {
            "buckets": [
                {
                    "key_as_string": "2023-01-01T00:00:00.000Z",
                    "key": 1672531200000,
                    "doc_count": 12,
                    "total_sales": {
                        "value": 24381.61993408203
                    }
                },
                {
                    "key_as_string": "2023-02-01T00:00:00.000Z",
                    "key": 1675209600000,
                    "doc_count": 11,
                    "total_sales": {
                        "value": 18870.850006103516
                    }
                },
                {
                    "key_as_string": "2023-03-01T00:00:00.000Z",
                    "key": 1677628800000,
                    "doc_count": 10,
                    "total_sales": {
                        "value": 17959.33026123047
                    }
                },
                {
                    "key_as_string": "2023-04-01T00:00:00.000Z",
                    "key": 1680307200000,
                    "doc_count": 9,
                    "total_sales": {
                        "value": 18775.959869384766
                    }
                },
                {
                    "key_as_string": "2023-05-01T00:00:00.000Z",
                    "key": 1682899200000,
                    "doc_count": 10,
                    "total_sales": {
                        "value": 11713.169967651367
                    }
                },
                {
                    "key_as_string": "2023-06-01T00:00:00.000Z",
                    "key": 1685577600000,
                    "doc_count": 9,
                    "total_sales": {
                        "value": 6771.1600341796875
                    }
                },
                {
                    "key_as_string": "2023-07-01T00:00:00.000Z",
                    "key": 1688169600000,
                    "doc_count": 7,
                    "total_sales": {
                        "value": 9110.010131835938
                    }
                },
                {
                    "key_as_string": "2023-08-01T00:00:00.000Z",
                    "key": 1690848000000,
                    "doc_count": 8,
                    "total_sales": {
                        "value": 12135.870210647583
                    }
                },
                {
                    "key_as_string": "2023-09-01T00:00:00.000Z",
                    "key": 1693526400000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 8615.500122070312
                    }
                },
                {
                    "key_as_string": "2023-10-01T00:00:00.000Z",
                    "key": 1696118400000,
                    "doc_count": 6,
                    "total_sales": {
                        "value": 12106.000183105469
                    }
                },
                {
                    "key_as_string": "2023-11-01T00:00:00.000Z",
                    "key": 1698796800000,
                    "doc_count": 6,
                    "total_sales": {
                        "value": 8176.529968261719
                    }
                },
                {
                    "key_as_string": "2023-12-01T00:00:00.000Z",
                    "key": 1701388800000,
                    "doc_count": 9,
                    "total_sales": {
                        "value": 12509.620300292969
                    }
                }
            ]
        }
    }
}
```

### 18. 计算每周的总销售额，并找出销售额增长最快的一周。

```
{
  "aggs": {
    "weekly_sales": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "week"
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "total_amount"
          }
        },
        "growth_rate": {
          "derivative": {
            "buckets_path": "total_sales"
          }
        }
      }
    }
  }
}

```
-![QQ20241012-174408](pot\QQ20241012-174408.png)

```
结果部分代码
    "aggregations": {
        "weekly_sales": {
            "buckets": [
                {
                    "key_as_string": "2023-01-02T00:00:00.000Z",
                    "key": 1672617600000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 4912.139953613281
                    }
                },
                {
                    "key_as_string": "2023-01-09T00:00:00.000Z",
                    "key": 1673222400000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 8571.68994140625
                    },
                    "growth_rate": {
                        "value": 3659.5499877929688
                    }
                },
                {
                    "key_as_string": "2023-01-16T00:00:00.000Z",
                    "key": 1673827200000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 3978.7000732421875
                    },
                    "growth_rate": {
                        "value": -4592.9898681640625
                    }
                },
                {
                    "key_as_string": "2023-01-23T00:00:00.000Z",
                    "key": 1674432000000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 6919.0899658203125
                    },
                    "growth_rate": {
                        "value": 2940.389892578125
                    }
                },
                {
                    "key_as_string": "2023-01-30T00:00:00.000Z",
                    "key": 1675036800000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 3605.800048828125
                    },
                    "growth_rate": {
                        "value": -3313.2899169921875
                    }
                },
                {
                    "key_as_string": "2023-02-06T00:00:00.000Z",
                    "key": 1675641600000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 635.1199951171875
                    },
                    "growth_rate": {
                        "value": -2970.6800537109375
                    }
                },
                {
                    "key_as_string": "2023-02-13T00:00:00.000Z",
                    "key": 1676246400000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 3622.939971923828
                    },
                    "growth_rate": {
                        "value": 2987.8199768066406
                    }
                },
                {
                    "key_as_string": "2023-02-20T00:00:00.000Z",
                    "key": 1676851200000,
                    "doc_count": 4,
                    "total_sales": {
                        "value": 7788.419982910156
                    },
                    "growth_rate": {
                        "value": 4165.480010986328
                    }
                },
                {
                    "key_as_string": "2023-02-27T00:00:00.000Z",
                    "key": 1677456000000,
                    "doc_count": 5,
                    "total_sales": {
                        "value": 9165.450073242188
                    },
                    "growth_rate": {
                        "value": 1377.0300903320312
                    }
                },
                {
                    "key_as_string": "2023-03-06T00:00:00.000Z",
                    "key": 1678060800000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 1358.5800170898438
                    },
                    "growth_rate": {
                        "value": -7806.870056152344
                    }
                },
                {
                    "key_as_string": "2023-03-13T00:00:00.000Z",
                    "key": 1678665600000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 6438.730224609375
                    },
                    "growth_rate": {
                        "value": 5080.150207519531
                    }
                },
                {
                    "key_as_string": "2023-03-20T00:00:00.000Z",
                    "key": 1679270400000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 600.6900024414062
                    },
                    "growth_rate": {
                        "value": -5838.040222167969
                    }
                },
                {
                    "key_as_string": "2023-03-27T00:00:00.000Z",
                    "key": 1679875200000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 4943.72998046875
                    },
                    "growth_rate": {
                        "value": 4343.039978027344
                    }
                },
                {
                    "key_as_string": "2023-04-03T00:00:00.000Z",
                    "key": 1680480000000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-04-10T00:00:00.000Z",
                    "key": 1681084800000,
                    "doc_count": 4,
                    "total_sales": {
                        "value": 8707.539825439453
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-04-17T00:00:00.000Z",
                    "key": 1681689600000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-04-24T00:00:00.000Z",
                    "key": 1682294400000,
                    "doc_count": 4,
                    "total_sales": {
                        "value": 8739.140014648438
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-05-01T00:00:00.000Z",
                    "key": 1682899200000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 3348.029998779297
                    },
                    "growth_rate": {
                        "value": -5391.110015869141
                    }
                },
                {
                    "key_as_string": "2023-05-08T00:00:00.000Z",
                    "key": 1683504000000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 2923.4099731445312
                    },
                    "growth_rate": {
                        "value": -424.6200256347656
                    }
                },
                {
                    "key_as_string": "2023-05-15T00:00:00.000Z",
                    "key": 1684108800000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 572.7400054931641
                    },
                    "growth_rate": {
                        "value": -2350.669967651367
                    }
                },
                {
                    "key_as_string": "2023-05-22T00:00:00.000Z",
                    "key": 1684713600000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 4489.47998046875
                    },
                    "growth_rate": {
                        "value": 3916.739974975586
                    }
                },
                {
                    "key_as_string": "2023-05-29T00:00:00.000Z",
                    "key": 1685318400000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 379.510009765625
                    },
                    "growth_rate": {
                        "value": -4109.969970703125
                    }
                },
                {
                    "key_as_string": "2023-06-05T00:00:00.000Z",
                    "key": 1685923200000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 904.010009765625
                    },
                    "growth_rate": {
                        "value": 524.5
                    }
                },
                {
                    "key_as_string": "2023-06-12T00:00:00.000Z",
                    "key": 1686528000000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 3652.4400024414062
                    },
                    "growth_rate": {
                        "value": 2748.4299926757812
                    }
                },
                {
                    "key_as_string": "2023-06-19T00:00:00.000Z",
                    "key": 1687132800000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 1073.9700012207031
                    },
                    "growth_rate": {
                        "value": -2578.470001220703
                    }
                },
                {
                    "key_as_string": "2023-06-26T00:00:00.000Z",
                    "key": 1687737600000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 1140.7400207519531
                    },
                    "growth_rate": {
                        "value": 66.77001953125
                    }
                },
                {
                    "key_as_string": "2023-07-03T00:00:00.000Z",
                    "key": 1688342400000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 3268.2000732421875
                    },
                    "growth_rate": {
                        "value": 2127.4600524902344
                    }
                },
                {
                    "key_as_string": "2023-07-10T00:00:00.000Z",
                    "key": 1688947200000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 1996.9200439453125
                    },
                    "growth_rate": {
                        "value": -1271.280029296875
                    }
                },
                {
                    "key_as_string": "2023-07-17T00:00:00.000Z",
                    "key": 1689552000000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 2220.9599609375
                    },
                    "growth_rate": {
                        "value": 224.0399169921875
                    }
                },
                {
                    "key_as_string": "2023-07-24T00:00:00.000Z",
                    "key": 1690156800000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 1623.9300537109375
                    },
                    "growth_rate": {
                        "value": -597.0299072265625
                    }
                },
                {
                    "key_as_string": "2023-07-31T00:00:00.000Z",
                    "key": 1690761600000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 5719.370178222656
                    },
                    "growth_rate": {
                        "value": 4095.4401245117188
                    }
                },
                {
                    "key_as_string": "2023-08-07T00:00:00.000Z",
                    "key": 1691366400000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-08-14T00:00:00.000Z",
                    "key": 1691971200000,
                    "doc_count": 4,
                    "total_sales": {
                        "value": 6387.220031738281
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-08-21T00:00:00.000Z",
                    "key": 1692576000000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 29.280000686645508
                    },
                    "growth_rate": {
                        "value": -6357.940031051636
                    }
                },
                {
                    "key_as_string": "2023-08-28T00:00:00.000Z",
                    "key": 1693180800000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-09-04T00:00:00.000Z",
                    "key": 1693785600000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-09-11T00:00:00.000Z",
                    "key": 1694390400000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 4886.10009765625
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-09-18T00:00:00.000Z",
                    "key": 1694995200000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 3729.4000244140625
                    },
                    "growth_rate": {
                        "value": -1156.7000732421875
                    }
                },
                {
                    "key_as_string": "2023-09-25T00:00:00.000Z",
                    "key": 1695600000000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-10-02T00:00:00.000Z",
                    "key": 1696204800000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 5857.110168457031
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-10-09T00:00:00.000Z",
                    "key": 1696809600000,
                    "doc_count": 4,
                    "total_sales": {
                        "value": 6248.8900146484375
                    },
                    "growth_rate": {
                        "value": 391.77984619140625
                    }
                },
                {
                    "key_as_string": "2023-10-16T00:00:00.000Z",
                    "key": 1697414400000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-10-23T00:00:00.000Z",
                    "key": 1698019200000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-10-30T00:00:00.000Z",
                    "key": 1698624000000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-11-06T00:00:00.000Z",
                    "key": 1699228800000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 342.6300048828125
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-11-13T00:00:00.000Z",
                    "key": 1699833600000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 3917.739990234375
                    },
                    "growth_rate": {
                        "value": 3575.1099853515625
                    }
                },
                {
                    "key_as_string": "2023-11-20T00:00:00.000Z",
                    "key": 1700438400000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 1300.9099731445312
                    },
                    "growth_rate": {
                        "value": -2616.8300170898438
                    }
                },
                {
                    "key_as_string": "2023-11-27T00:00:00.000Z",
                    "key": 1701043200000,
                    "doc_count": 2,
                    "total_sales": {
                        "value": 3575.4299926757812
                    },
                    "growth_rate": {
                        "value": 2274.52001953125
                    }
                },
                {
                    "key_as_string": "2023-12-04T00:00:00.000Z",
                    "key": 1701648000000,
                    "doc_count": 1,
                    "total_sales": {
                        "value": 1498.1099853515625
                    },
                    "growth_rate": {
                        "value": -2077.3200073242188
                    }
                },
                {
                    "key_as_string": "2023-12-11T00:00:00.000Z",
                    "key": 1702252800000,
                    "doc_count": 0,
                    "total_sales": {
                        "value": 0.0
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-12-18T00:00:00.000Z",
                    "key": 1702857600000,
                    "doc_count": 3,
                    "total_sales": {
                        "value": 2833.2600708007812
                    },
                    "growth_rate": {
                        "value": null
                    }
                },
                {
                    "key_as_string": "2023-12-25T00:00:00.000Z",
                    "key": 1703462400000,
                    "doc_count": 4,
                    "total_sales": {
                        "value": 7218.070251464844
                    },
                    "growth_rate": {
                        "value": 4384.8101806640625
                    }
                }
            ]
        }
    }
}
```
## 三.问题及解决办法
```
{
  "size": 0,
  "aggs": {
    "top_10_dates_by_sales": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "day",
        "order": {
          "total_sales": "desc"
        },
        "size": 10
      },
      "aggs": {
        "total_sales": {
          "sum": {
            "field": "total_amount"
          }
        }
      }
    }
  }
}
{
    "error": {
        "root_cause": [
            {
                "type": "x_content_parse_exception",
                "reason": "[11:9] [date_histogram] unknown field [size]"
            }
        ],
        "type": "x_content_parse_exception",
        "reason": "[11:9] [date_histogram] unknown field [size]"
    },
    "status": 400
}
```

![QQ20241012-181322](pot\QQ20241012-181322.png)

`date_histogram` 没有 `size` 字段